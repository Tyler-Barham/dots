# shellcheck shell=bash

alias home-up="home-manager switch --flake $(realpath ~/.config/home-manager)#$USER@$HOSTNAME"
alias rsync='rsync -ah --info=progress2 --info=name0'
alias vimdiff='nvim -d'
alias ip='ip --color'
alias chafa='chafa -f sixels'
alias watch='viddy'

function silent() { "$@" >/dev/null 2>&1; }

function chafa-url() {
    if [ $# -lt 1 ]; then
        echo "Usage: chafa-url <url> [chafa options...]"
        return 1
    fi

    url="$1"
    shift
    curl -sL "$url" | chafa - "$@"
}

function make() {
    # Bypass bear
    if [[ "$*" == *"clean"* ]]; then
        /usr/bin/make $*
        return $?
    fi

    # Setup bear args
    bear_cmd=""
    if [[ $(bear --version 2>/dev/null) == "bear 2"* ]]; then
        bear_cmd="bear --append"
    elif [[ $(bear --version 2>/dev/null) == "bear 3"* ]]; then
        bear_cmd="bear --append --"
    fi

    # Call make, conditionally with bear
    $bear_cmd /usr/bin/make $*
}

if [[ "$(cat /proc/$$/comm)" == "bash" ]]; then
    export -f make
elif [[ "$(cat /proc/$$/comm)" == "zsh" ]]; then
    setopt shwordsplit
fi

function ips() {
    local ifaces=($(ip --color=never -br a | awk -F '[[:space:]]+' '{if ($2=="UP") {print $1}}'))
    for ifa in ${ifaces[@]}; do
        if [[ "$ifa" == "docker"* || "$ifa" == *"tun"* || "$ifa" == "lo" ]]; then
            continue;
        fi

        # Scan the iface and print indented output
        echo "$ifa:"
        sudo arp-scan --interface "$ifa" --localnet --plain | sed 's/^/\t/'

        # Output an empty line if not the last iface in the loop
        [[ $ifa != "${ifaces[-1]}" ]] && echo ""
    done

}
function lg() { lazygit; }
function lzd() { lazydocker; }
function mkcd() { mkdir -p "$@" && cd "$@" || return; }
function cleantmp() { sudo find /tmp/* -maxdepth 0 -mtime +2 -exec rm -rf {} \;; }
function vimit() { if [[ -r $1 ]]; then nvim "$1"; else nvim "$(which "$1")"; fi; }
function ducks() { du -cksh ./* | sort -hr | head -n 15; }

# SVC
function gup() { git fetch && git pull && git submodule update --recursive; }
function git-clean-br() { git fetch -p && for branch in $(git for-each-ref --format '%(refname) %(upstream:track)' refs/heads | awk '$2 == "[gone]" {sub("refs/heads/", "", $1); print $1}'); do git branch -D "$branch"; done; }

# Conda
function conda-pyv() { conda env list | grep -v "^$\|#" | awk '{print $1;}' | xargs -I{} -d "\n" sh -c 'printf "Env: {}\t"; conda list -n {} | grep "^python\s";'; }

